<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Wheeler Map</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
	<script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
	<script src="https://d3js.org/d3.v6.min.js"></script>
	<link href='style.css' rel='stylesheet' />
	<script src='data.geojson'></script>
	<script src="https://kit.fontawesome.com/a8a802a6de.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
</head>
<body style="margin:0;">
	<!-- Load the `mapbox-gl-geocoder` plugin. --> 
	<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
	<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" type="text/css">
	<!-- Promise polyfill script is required -->
	<!-- to use Mapbox GL Geocoder in IE 11. -->
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
	
	<div id='map'></div>
	<div id='floorSelector' class='mapboxgl-ctrl-top-right mapboxgl-ctrl mapboxgl-ctrl-group'>
		<div class='floor floor-3' data-floor='3' type='button'>3</div>
		<div class='floor floor-2' data-floor='2' type='button'>2</div>
		<div class='floor floor-1 clicked' data-floor='1' type='button'>1</div>
	</div>

	<script>
		// Mapbox token
		mapboxgl.accessToken = 'pk.eyJ1IjoiaXNhaWFoc3VjaG1hbiIsImEiOiJja29tYml4dnUwMTh5MnBwZDc3Y3h6bWFzIn0.6vb_akj8V9jTxiBtlOMRGg';
		
		// Initiate map
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v11',
			center: [-71.398646, 41.828826],
			zoom: 18
		});
		
		// Add custom data to geocoder
		function customGeocoder(query) {
			var matchingFeatures = [];
			for (var i = 0; i < customData.features.length; i++) {
				var feature = customData.features[i];
				for (var j = 0; j < feature.properties.names.length; j++) {
					console.log(feature.properties.names[j]);
					// Handle queries with different capitalization than the source data by calling toLowerCase().
					if (
						feature.properties.names[j]
						.toLowerCase()
						.search(query.toLowerCase()) !== -1
					) {
						// Use Carmen geojson format:
						// https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
						feature['place_name']	 = feature.properties.title;
						if (feature.geometry.type == "Point") {
							feature['center'] = feature.geometry.coordinates;
						} else {
							var centroid = turf.centerOfMass(turf.polygon(feature.geometry.coordinates));
							feature['center'] = centroid.geometry.coordinates;
						}
						feature['place_type'] = feature.properties.place_type; 
						console.log(turf.centroid(turf.polygon(feature.geometry.coordinates)));
						matchingFeatures.push(feature);
					}
				}
			}
			return matchingFeatures;
		}
		
		// Add geocoder control to map
		map.addControl(
			new MapboxGeocoder({
				accessToken: mapboxgl.accessToken,
				localGeocoder: customGeocoder,
				localGeocoderOnly: true,
				zoom: 21,
				bbox: [-71.39971460574294,41.82809919529407,-71.39671714876509,41.83013742558967],
				mapboxgl: mapboxgl,
				marker: {
					color: 'orange'
				},
				render: function (item) {
					var icon = item.properties.icon || 'icon';
					return (
						"<div class='geocoder-dropdown-item'><i class='" + 
						item.properties.icon +
						"'></i><span class='geocoder-dropdown-text'>" +
						item.place_name +
						'</span></div>'
					);
				},
				placeholder: 'Enter search...'
			}),
			'top-left'
		);
		
		// Add polygon highlighting on search
		
		// Add polygon highlighting feature
		
		
		// Add zoom and rotation controls to the map.
		map.addControl(new mapboxgl.NavigationControl());
		
		// Add geolocate control to the map.
		map.addControl(
			new mapboxgl.GeolocateControl({
				positionOptions: {
					enableHighAccuracy: true
				},
				trackUserLocation: true,
				fitBoundsOptions: {
					maxZoom: 20
				},
				showAccuracyCircle: false
			})
		);
		
		// Define max bounds of map
		var bounds = [
			[-71.402489,41.826071],
			[-71.394685,41.831241],
		];
		map.setMaxBounds(bounds);
		
		map.on('load', function () {
			// Add custom geojson as new source
			map.addSource('custom_data', {
				'type': 'geojson',
				'data': customData
			});
			
			// Add custom images for point icons
			var images = [
				{
					imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Recycling_symbol.svg/2095px-Recycling_symbol.svg.png',
					id: 'recycling'
				}
				// add other icons!
			];
			
			Promise.all(
				images.map(img => new Promise((resolve, reject) => {
					map.loadImage(img.url, function (error, res) {
						map.addImage(img.id, res, { sdf: true })
						resolve();
					})
				}))
			)
			.then((value) => {
				// Add custom geojson source as a bunch of layers
				customData.features.forEach(function (feature) {
					var place_type = feature.properties['place_type'];
					var floor = feature.properties['floor'];
					var layerID = place_type + "-floor-" + floor;
					var type;
					if (feature.geometry.type == "Polygon") {
						type = "fill";
					} else if (feature.geometry.type == "LineString") {
						type = "line";
					} else if (feature.geometry.type == "Point") {
						type = "symbol";
					}
					if (!map.getLayer(layerID)) {
						if (type == "fill") {
							map.addLayer({
								'id': layerID,
								'type': type,
								'minzoom': 19,
								'source': 'custom_data',
								'paint': {
									'fill-color': '#444',
									'fill-opacity': 1
								},
								'filter': ['all', ['==', '$type', 'Polygon'], ['==', 'floor', floor]]
							});
							map.addLayer({
								'id': layerID + "-highlighted",
								'type': 'line',
								'minzoom': 19,
								'source': 'custom_data',
								'paint': {
									'line-color': '#00ff00',
									'line-opacity': 1,
									'line-width': 10
								},
								'filter': ['all', ['==', '$type', 'Polygon'], ['==', 'floor', floor]]
							});
						} else if (type == "line") {
							map.addLayer({
								'id': layerID,
								'type': 'line', 
								'minzoom': 19,
								'source': 'custom_data',
								// add some paint styling for lines
								'filter': ['all', ['==', '$type', 'LineString'], ['==', 'floor', floor]]
							});
						} else if (type == "symbol") {
							map.addLayer({
								'id': layerID,
								'type': 'symbol', // should actually be symbol...
								'minzoom': 19,
								'source': 'custom_data',
								'layout': {
									'icon-image': place_type,
									'icon-size': 0.25
								},
								'filter': ['all', ['==', '$type', 'Point'], ['==', 'floor', floor]]
							});
						}
					}
				});
			})
			
			// Get all floor-toggled layers
			var floorLayerIDs = [];
			map.getStyle().layers.forEach(function(layer) {
				if (layer.id.includes("floor-1") 
					|| layer.id.includes("floor-2")
					|| layer.id.includes("floor-3")
				) {
					floorLayerIDs.push(layer.id);
				}
			});
			
			// Set default to visible first floor
			changeFloor(1);
			
			// Floor change function
			function changeFloor(clickedFloor) {
				floorLayerIDs.forEach(function(id) {
					if (id.includes(clickedFloor)
						&& !id.includes("highlighted")
					) {
						map.setLayoutProperty(id, 'visibility', 'visible');
					} else {
						map.setLayoutProperty(id, 'visibility', 'none');
					}
				});
			};
			
			// Floor selector buttons change on click
			var floorButtons = document.getElementById('floorSelector');
			floorButtons.onclick = function(e) {
				if (!e.target.classList.contains('clicked')) {
					var clickedFloor = parseInt(e.target.getAttribute('data-floor')) 
					var floorEls = Array.prototype.slice.call(document.getElementsByClassName('floor'));	
					floorEls.forEach(function(el, i){
						if (el.classList.contains('clicked') || el.getAttribute('data-floor') == clickedFloor) {
							el.classList.toggle('clicked');
						}
					});
					changeFloor(clickedFloor);
				}
			};
		});
	</script>
</body>
</html>

